/**
*
*   ModelViewForm.js
*   Declarative MV Form building, rendering, validation 
*   @dependencies: jQuery, ModelView
*   @version: 0.6
*
*   https://github.com/foo123/modelview.js
*   https://github.com/foo123/modelview-form.js
*
**/
!function(e,t,a){"use strict";function r(e){return e.replace(k,".$1").replace(x,"")}function i(e){return"data-mvform-"+e}function o(e,t){return t.checked}function s(e){var t;return e.checked?e.value:(t=e.getAttribute("data-else"))?t:""}function n(e){return!!e&&e.length}function l(e,t){t=t||[];var a,r,i,o,s,n,l=e.val(),d="";for(a=0,r=t.length;r>a;a++)i=t[a],N(i)?(o=i.key,s=i.value):(o=i,s=i),d+='<option value="'+o+'">'+s+"</option>";return n=e.children("optgroup"),n=n.length?n.eq(0):e,n.children("option:not(.default)").remove(),n.append(d),e.val(l),e}function d(e,a){a=a||[];var r,i,o,s,n,l=t("#"+e.attr("list")),d="";for(r=0,i=a.length;i>r;r++)o=a[r],N(o)?(s=o.key,n=o.value):(s=o,n=o),d+='<option value="'+s+'">'+n+"</option>";return l.html(d),e}function u(e,a){var o=a.$view.$model,s=o.id+".",n=!1,d={};e.each(function(){var e,a,o,l,u=t(this),c=u.attr("name");c&&(e=r(c),s===e.slice(0,s.length)&&(e=e.slice(s.length),l=u.attr(i("ajax-options")),a=u.attr(i("key")),o=u.attr(i("ajax-key")),o||(o=a),o&&a&&l&&(d[a]={key:o,model_key:a,options:l,$el:u},n=!0)))}),n&&(o.on("change",function(e,t){var r,i;t.key&&d[h](t.key)&&(i=d[t.key],r={},r[i.key]=o.get(i.model_key),i.$el.addClass("mvform-progress"),a.trigger("before-ajax-options",i),f.doGET(i.options,r,function(e,t){l(i.$el,t||[]).removeClass("mvform-progress").trigger("change"),a.trigger("after-ajax-options",i)}))}),o.notify($(d),"change"))}function c(e,a){var o=a.$view.$model,s=o.id+".",n={},l=!1,u=2,c={},m=6e4,v=200;e.each(function(){var e,a,o,d,u=t(this),m=u.attr("name");m&&(e=r(m),s===e.slice(0,s.length)&&(e=e.slice(s.length),o=u.attr(i("ajax-suggest")),a=u.attr(i("ajax-key")),a||(a=e),d=S("suggestlist"),u.after('<datalist id="'+d+'"></datalist>'),u.attr("list",d),n[m]={key:e,ajax_key:a,suggest:o,stop_typing:0,suggesting:!1,$el:u},c[e]={},l=!0))}),l&&a.$form.on("keypress","input["+i("ajax-suggest")+"]",function(){var e,t=this;t.name&&n[h](t.name)&&(e=n[t.name],e.stop_typing=(new Date).getTime()+v,setTimeout(function(){var r,i,o,s,n=(new Date).getTime();if(!(e.stop_typing>n||(s=I(t.value||""),s.length<u)))if(i=null,o=c[e.key],o[h](s)&&(o[s].expires<n?i=o[s].suggestions:delete o[s]),null!==i)d(e.$el,i);else{if(e.suggesting)return;e.suggesting=!0,r={},r[e.ajax_key]=s,e.$el.addClass("mvform-progress"),a.trigger("before-ajax-suggest",e),f.doGET(e.suggest,r,function(t,r){e.suggesting=!1,i=r||[],o[s]={expires:(new Date).getTime()+m,suggestions:i},d(e.$el,i).removeClass("mvform-progress"),a.trigger("after-ajax-suggest",e)})}},v+100))})}function m(e,a,l){var d=a.id+".",u={};e.each(function(){var e,c,m,v,f,g,p,$,b,N,A,k,x,I,O,R,_,C=t(this),L=C.attr("name"),V=!1;if(L&&!u[L]&&(e=r(L),d===e.slice(0,d.length))){if(e=e.slice(d.length),f=C.val()||"",g="",b=(C.attr("type")||"")[E](),x="radio"===b||"checkbox"===b,N=!!C.attr("required"),A=!!C.attr(i("required")),I=C.attr("data-else"),O=!!I,V="checkbox"===b&&w.test(L),C.attr("id")||C.attr("id",S(e.split(".").join("_"))),$=C.attr(i("type"))||b)switch($=$[T]()){case"NUMBER":case"INTEGER":case"INT":a.types[e]=M.INT,f=M.INT(f)||0,g=0,x&&!V&&O&&(g=M.INT(I)||0);break;case"DATE":case"TIME":case"DATETIME":case"EMAIL":case"URL":case"TEXT":case"STRING":case"STR":a.types[e]=M.STR,f=M.STR(f)||"",g="",x&&!V&&O&&(g=M.STR(I)||"");break;case"BOOLEAN":case"BOOL":a.types[e]=M.BOOL,f=M.BOOL(f)||!1,g=!f,x&&!V&&O&&(g=M.BOOL(I));break;default:M[h]($)&&(a.types[e]=M[$],x&&!V&&O&&(g=M[$](I)))}for(V||((p=C.attr(i("validate")))||N||A||"email"===b||"url"===b||"datetime"===b||"date"===b||"time"===b)&&(p&&D[h](p=p[T]())?"BETWEEN"===p?(_=[parseInt(C.attr(i("min")),10),parseInt(C.attr(i("max")),10)],isNaN(_[0])||isNaN(_[1])||(a.validators[e]=a.validators[h](e)?a.validators[e].AND(D.BETWEEN(_[0],_[1],!1)):D.BETWEEN(_[0],_[1],!1))):"GREATER_THAN"===p?(_=parseInt(C.attr(i("min")),10),isNaN(_)||(a.validators[e]=a.validators[h](e)?a.validators[e].AND(D.GREATER_THAN(_,!0)):D.GREATER_THAN(_,!0))):"LESS_THAN"===p?(_=parseInt(C.attr(i("max")),10),isNaN(_)||(a.validators[e]=a.validators[h](e)?a.validators[e].AND(D.LESS_THAN(_,!0)):D.LESS_THAN(_,!0))):"DATETIME"===p||"DATE"===p||"TIME"===p?(_=C.attr(i("format"))||"Y-m-d",a.validators[e]=a.validators[h](e)?a.validators[e].AND(D.DATETIME(_,l&&l.datetime?l.datetime:null)):D.DATETIME(_,l&&l.datetime?l.datetime:null)):a.validators[e]=a.validators[h](e)?a.validators[e].AND(D[p]):D[p]:"email"===b?a.validators[e]=a.validators[h](e)?a.validators[e].AND(D.EMAIL):D.EMAIL:"url"===b?a.validators[e]=a.validators[h](e)?a.validators[e].AND(D.URL):D.URL:("datetime"===b||"date"===b||"time"===b)&&(_=C.attr(i("format"))||"Y-m-d",a.validators[e]=a.validators[h](e)?a.validators[e].AND(D.DATETIME(_,l&&l.datetime?l.datetime:null)):D.DATETIME(_,l&&l.datetime?l.datetime:null)),C.attr(i("bind"),y({error:"error",change:"change"}))),N||A?(k=V?D.MIN_ITEMS(parseInt(C.attr(i("leastrequired")),10)||1,n):D.NOT_EMPTY,a.validators[e]=a.validators[h](e)?k.AND(a.validators[e]):k,a.validators[e].REQUIRED=1,N&&C.removeAttr("required"),C.attr(i("bind"))||C.attr(i("bind"),y({error:"error",change:"change"}))):V||"function"!=typeof a.validators[e]||a.validators[e].REQUIRED||(a.validators[e]=D.EMPTY.OR(a.validators[e])),c=e.split("."),v=a.data;c.length;)m=c.shift(),c.length?(v[h](m)||(v[m]=j.test(c[0])?[]:{}),v=v[m]):(v[h](m)||(v[m]=V?[]:g),x?"radio"===b&&C.prop("checked")?v[m]=f:"checkbox"===b&&(R=t(C[0].form).find('input[type="checkbox"][name="'+L+'"]'),v[m]=V?t.map(R.filter(o),s):R.length>1?t.map(R,s):O?C.prop("checked")?f:g:C.prop("checked")?f:g,u[L]=1):v[m]=f)}})}var v,f,g=Object.create,p="prototype",h="hasOwnProperty",T="toUpperCase",E="toLowerCase",$=Object.keys,y=JSON.stringify,b=Object[p].toString,N=function(e){return e instanceof Object||"[object Object]"===b.call(e)},w=/\[\s*\]$/,A=/^\s+|\s+$/g,j=/^\d+$/,k=/\[([^\]]*)\]/g,x=/^\.+|\.+$/g,I=String[p].trim?function(e){return e.trim()}:function(e){return e.replace(A,"")},S=a.UUID,M=a.Type.Cast,D=a.Validation.Validate,O=a.Model;v=function(){var e=this;a.View.apply(e,arguments)},v[p]=g(a.View[p]),v[p].do_change=function(e,a){var r=t(a);a.validity.valid||a.setCustomValidity(""),r.hasClass("mvform-error")&&r.removeClass("mvform-error")},v[p].do_error=function(e,a){var r=t(a);a.validity.valid||a.setCustomValidity(""),r.hasClass("mvform-error")||r.addClass("mvform-error")},f=e.ModelViewForm=function R(e){var a=this;return a instanceof R?(a.id=S("mvform"),a.$options=t.extend({submit:!0,notify:!0,model:!1,livebind:!1,prefixed:!1,locale:{},Model:R.Model,View:R.View,ajax:!1},e||{}),void a.initPubSub()):new R(e)},f.VERSION="0.6",f.Model=O,f.View=v,f.doSubmit=function(e,a){return a=a||"json",function(r,i,o){var s=function(e,t){"success"==t?o(!0,e):o(!1,e)};t.ajax({type:e,dataType:a,url:r,data:i||null,success:s,error:s})}},f.doGET=f.doSubmit("GET","json"),f.doPOST=f.doSubmit("POST","json"),f.fields2model=m,f[p]=a.Extend(g(Object[p]),a.PublishSubscribeInterface,{constructor:f,id:null,$form:null,$view:null,$messages:null,$options:null,dispose:function(){var e=this;return e.disposePubSub(),e.$form&&(e.$form.off("submit."+e.id),e.$form.modelview("dispose"),e.$form.removeClass("mvform")),e.$form=null,e.$view=null,e.$messages=null,e.$options=null,e.id=null,e},trigger:function(e,t,r){var i=this,o=a.PublishSubscribeInterface.trigger;return r=r||0,r>0?setTimeout(function(){o.call(i,e,t)},r):o.call(i,e,t),i},one:function(e,t){return this.on(e,t,!0)},dom:function(e){var a=this;return a.$form=t(e),a._render(),a},tpl:function(e,a){var r=this;return r.$form=t(e.innerHTML).appendTo(a),r._render(),r},serialize:function(){var e=this,t={};return t[e.$view.$model.id]=e.$view.$model.serialize(),t},validate:function(){{var e,t=this;t.$form,t.$options||{}}return t.trigger("before-validate"),e=t.$view.$model.validate(),t.trigger("after-validate",e),e},notify:function(e){var t,a,r,o=this,s=o.$form;return s&&s.length&&e&&e.length&&(o.$view.$model.notify(e,"error"),o.$messages&&o.$messages.length&&(t=o.$options.prefixed?o.$view.$model.id+".":"",a=i("error")+'="'+t,r="["+a+e.join('"],['+a)+'"]',o.$messages.hide(),s.find(r).show())),o},_render:function(){var e,t=this,a=t.$options||{},r=a.Model||f.Model,o=a.View||f.View,s=t.$form,n={id:a.model?a.model:(e=s.attr(i("model")))?e:"model",data:{},types:{},validators:{},getters:{},setters:{},dependencies:{}};return s.addClass("mvform").attr("id",s[0].id||S("mvform")),t.trigger("before-render"),t.$messages=s.find("["+i("error")+"]").hide(),m(s.find("input,textarea,select"),n,a.locale),s.modelview({autoSync:!0,autobind:!0,livebind:a.livebind,isomorphic:!1,autovalidate:!1,bindAttribute:i("bind"),events:["change","error","click"],model:n,modelClass:r,viewClass:o}),t.$view=s.modelview("view"),c(s.find("input["+i("ajax-suggest")+"]"),t),u(s.find("select["+i("ajax-options")+"]"),t),a.submit&&s.on("submit."+t.id,function(e){var a,r,i=t.$options;return e.preventDefault(),e.stopPropagation(),t.$messages.hide(),a=t.validate(),a.isValid?i.ajax?(t.trigger("before-send",r=t.serialize()),r&&i.ajax&&f.doPOST(i.ajax,r,function(e,a){t.trigger("after-send",{success:e,response:a})})):t.trigger("submit",t.serialize()):i.notify&&t.notify(a.errors),!1}),t.trigger("after-render"),t}})}(window,jQuery,ModelView);