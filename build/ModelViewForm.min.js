/**
*
*   ModelViewForm.js
*   Declarative MV Form building, rendering, validation 
*   @dependencies: jQuery, ModelView
*   @version: 0.6
*
*   https://github.com/foo123/modelview.js
*   https://github.com/foo123/modelview-form.js
*
**/
!function(e,t,r){"use strict";function a(e){return e.replace(w,".$1").replace(I,"")}function i(e){return"data-mvform-"+e}function o(e,t){return t.checked}function n(e){var t;return e.checked?e.value:(t=e.getAttribute("data-else"))?t:""}function s(e){return!!e&&e.length}function l(e,t){t=t||[];var r,a,i,o,n,s,l=e.val(),d="";for(r=0,a=t.length;a>r;r++)i=t[r],b(i)?(o=i.key,n=i.value):(o=i,n=i),d+='<option value="'+o+'">'+n+"</option>";return s=e.children("optgroup"),s=s.length?s.eq(0):e,s.children("option:not(.default)").remove(),s.append(d),e.val(l),e}function d(e,r){var o=r.id+".",n=!1,s={};return e.each(function(){var e,r,l,d,c=t(this),u=c.attr("name");u&&(e=a(u),o===e.slice(0,o.length)&&(e=e.slice(o.length),d=c.attr(i("ajax-options")),r=c.attr(i("key")),l=c.attr(i("ajax-key")),l&&r&&d&&(s[r]={key:l,model_key:r,options:d,$el:c},n=!0)))}),n&&r.on("change",function(e,t){var a,i;t.key&&s[p](t.key)&&(i=s[t.key],a={},a[i.key]=r.get(i.model_key),i.$el.addClass("mvform-progress"),v.doGET(i.options,a,function(e,t){l(i.$el,t||[]).removeClass("mvform-progress").trigger("change")}))}),$(s)}function c(e,r,l){var d=r.id+".",c={};e.each(function(){var e,u,v,m,f,$,E,b,N,w,I,R,D,j,S,x,L,_=t(this),C=_.attr("name"),V=!1;if(C&&!c[C]&&(e=a(C),d===e.slice(0,d.length))){if(e=e.slice(d.length),f=_.val()||"",$="",N=(_.attr("type")||"")[h](),D="radio"===N||"checkbox"===N,w=!!_.attr("required"),I=!!_.attr(i("required")),j=_.attr("data-else"),S=!!j,V="checkbox"===N&&y.test(C),_.attr("id")||_.attr("id",M(e.split(".").join("_"))),b=_.attr(i("type"))||N)switch(b=b[g]()){case"NUMBER":case"INTEGER":case"INT":r.types[e]=k.INT,f=k.INT(f)||0,$=0,D&&!V&&S&&($=k.INT(j)||0);break;case"DATE":case"TIME":case"DATETIME":case"EMAIL":case"URL":case"TEXT":case"STRING":case"STR":r.types[e]=k.STR,f=k.STR(f)||"",$="",D&&!V&&S&&($=k.STR(j)||"");break;case"BOOLEAN":case"BOOL":r.types[e]=k.BOOL,f=k.BOOL(f)||!1,$=!f,D&&!V&&S&&($=k.BOOL(j));break;default:k[p](b)&&(r.types[e]=k[b],D&&!V&&S&&($=k[b](j)))}for(V||((E=_.attr(i("validate")))||w||I||"email"===N||"url"===N||"datetime"===N||"date"===N||"time"===N)&&(E&&O[p](E=E[g]())?"BETWEEN"===E?(L=[parseInt(_.attr(i("min")),10),parseInt(_.attr(i("max")),10)],isNaN(L[0])||isNaN(L[1])||(r.validators[e]=r.validators[p](e)?r.validators[e].AND(O.BETWEEN(L[0],L[1],!1)):O.BETWEEN(L[0],L[1],!1))):"GREATER_THAN"===E?(L=parseInt(_.attr(i("min")),10),isNaN(L)||(r.validators[e]=r.validators[p](e)?r.validators[e].AND(O.GREATER_THAN(L,!0)):O.GREATER_THAN(L,!0))):"LESS_THAN"===E?(L=parseInt(_.attr(i("max")),10),isNaN(L)||(r.validators[e]=r.validators[p](e)?r.validators[e].AND(O.LESS_THAN(L,!0)):O.LESS_THAN(L,!0))):"DATETIME"===E||"DATE"===E||"TIME"===E?(L=_.attr(i("format"))||"Y-m-d",r.validators[e]=r.validators[p](e)?r.validators[e].AND(O.DATETIME(L,l&&l.datetime?l.datetime:null)):O.DATETIME(L,l&&l.datetime?l.datetime:null)):r.validators[e]=r.validators[p](e)?r.validators[e].AND(O[E]):O[E]:"email"===N?r.validators[e]=r.validators[p](e)?r.validators[e].AND(O.EMAIL):O.EMAIL:"url"===N?r.validators[e]=r.validators[p](e)?r.validators[e].AND(O.URL):O.URL:("datetime"===N||"date"===N||"time"===N)&&(L=_.attr(i("format"))||"Y-m-d",r.validators[e]=r.validators[p](e)?r.validators[e].AND(O.DATETIME(L,l&&l.datetime?l.datetime:null)):O.DATETIME(L,l&&l.datetime?l.datetime:null)),_.attr(i("bind"),T({error:"error",change:"change"}))),w||I?(R=V?O.MIN_ITEMS(parseInt(_.attr(i("leastrequired")),10)||1,s):O.NOT_EMPTY,r.validators[e]=r.validators[p](e)?R.AND(r.validators[e]):R,r.validators[e].REQUIRED=1,w&&_.removeAttr("required"),_.attr(i("bind"))||_.attr(i("bind"),T({error:"error",change:"change"}))):V||"function"!=typeof r.validators[e]||r.validators[e].REQUIRED||(r.validators[e]=O.EMPTY.OR(r.validators[e])),u=e.split("."),m=r.data;u.length;)v=u.shift(),u.length?(m[p](v)||(m[v]=A.test(u[0])?[]:{}),m=m[v]):(m[p](v)||(m[v]=V?[]:$),D?"radio"===N&&_.prop("checked")?m[v]=f:"checkbox"===N&&(x=t(_[0].form).find('input[type="checkbox"][name="'+C+'"]'),m[v]=V?t.map(x.filter(o),n):x.length>1?t.map(x,n):S?_.prop("checked")?f:$:_.prop("checked")?f:$,c[C]=1):m[v]=f)}})}var u,v,m=Object.create,f="prototype",p="hasOwnProperty",g="toUpperCase",h="toLowerCase",$=Object.keys,T=JSON.stringify,E=Object[f].toString,b=function(e){return e instanceof Object||"[object Object]"===E.call(e)},y=/\[\s*\]$/,N=/^\s+|\s+$/g,A=/^\d+$/,w=/\[([^\]]*)\]/g,I=/^\.+|\.+$/g,M=(String[f].trim?function(e){return e.trim()}:function(e){return e.replace(N,"")},r.UUID),k=r.Type.Cast,O=r.Validation.Validate,R=r.Model;u=function(){var e=this;r.View.apply(e,arguments)},u[f]=m(r.View[f]),u[f].do_change=function(e,r){var a=t(r);r.validity.valid||r.setCustomValidity(""),a.hasClass("mvform-error")&&a.removeClass("mvform-error")},u[f].do_error=function(e,r){var a=t(r);r.validity.valid||r.setCustomValidity(""),a.hasClass("mvform-error")||a.addClass("mvform-error")},v=e.ModelViewForm=function D(e){var r=this;return r instanceof D?(r.id=M("mvform"),r.$pb=t({}),void(r.$options=t.extend({submit:!0,notify:!0,model:!1,livebind:!1,prefixed:!1,locale:{},Model:D.Model,View:D.View,ajax:!1},e||{}))):new D(e)},v.VERSION="0.6",v.Model=R,v.View=u,v.doGET=function(e,r,a){var i=function(e,t){"success"==t?a(!0,e):a(!1,e)};t.ajax({type:"GET",dataType:"json",url:e,data:r||null,success:i,error:i})},v.doPOST=function(e,r,a){var i=function(e,t){"success"==t?a(!0,e):a(!1,e)};t.ajax({type:"POST",dataType:"json",url:e,data:r||null,success:i,error:i})},v.fields2model=c,v[f]={constructor:v,id:null,$pb:null,$form:null,$view:null,$messages:null,$options:null,dispose:function(){var e=this;return e.$pb.off(),e.$pb=null,e.$form&&(e.$form.off("submit."+e.id),e.$form.modelview("dispose"),e.$form.removeClass("mvform")),e.$form=null,e.$view=null,e.$messages=null,e.$options=null,e.id=null,e},trigger:function(e,t,r){var a=this,i={};return r=r||0,i.data=t||null,i.mvform=a,r>0?setTimeout(function(){a.$pb.trigger(e,i)},r):a.$pb.trigger(e,i),a},on:function(e,t){var r=this;return r.$pb.on(e,t),r},one:function(e,t){var r=this;return r.$pb.one(e,t),r},off:function(e){var t=this;return arguments.length>1?t.$pb.off(e,arguments[1]):e&&t.$pb.off(e),t},dom:function(e){var r=this;return r.$form=t(e),r._render(),r},tpl:function(e,r){var a=this;return a.$form=t(e.innerHTML).appendTo(r),a._render(),a},serialize:function(){var e=this,t={};return t[e.$view.$model.id]=e.$view.$model.serialize(),t},validate:function(){{var e,t=this;t.$form,t.$options||{}}return t.trigger("before-validate"),e=t.$view.$model.validate(),t.trigger("after-validate",e),e},notify:function(e){var t,r,a,o=this,n=o.$form;return n&&n.length&&e&&e.length&&(o.$view.$model.notify(e,"error"),o.$messages&&o.$messages.length&&(t=o.$options.prefixed?o.$view.$model.id+".":"",r=i("error")+'="'+t,a="["+r+e.join('"],['+r)+'"]',o.$messages.hide(),n.find(a).show())),o},_render:function(){var e,t,r=this,a=r.$options||{},o=a.Model||v.Model,n=a.View||v.View,s=r.$form,l={id:a.model?a.model:(e=s.attr(i("model")))?e:"model",data:{},types:{},validators:{},getters:{},setters:{},dependencies:{}};return s.addClass("mvform").attr("id",s[0].id||M("mvform")),r.trigger("before-render"),r.$messages=s.find("["+i("error")+"]").hide(),c(s.find("input,textarea,select"),l,a.locale),s.modelview({autoSync:!1,autobind:!0,livebind:a.livebind,isomorphic:!1,autovalidate:!1,bindAttribute:i("bind"),events:["change","error","click"],model:l,modelClass:o,viewClass:n}),r.$view=s.modelview("view"),t=d(s.find("select["+i("ajax-options")+"]"),r.$view.$model),a.submit&&s.on("submit."+r.id,function(e){var t,a,i=r.$options;return e.preventDefault(),e.stopPropagation(),r.$messages.hide(),t=r.validate(),t.isValid?i.ajax?(r.trigger("before-send",a=r.serialize()),a&&i.ajax&&v.doPOST(i.ajax,a,function(e,t){r.trigger("after-send",{success:e,response:t})})):r.trigger("submit",r.serialize()):i.notify&&r.notify(t.errors),!1}),s.modelview("sync"),t.length&&r.$view.$model.notify(t,"change"),r.trigger("after-render"),r}}}(window,jQuery,ModelView);