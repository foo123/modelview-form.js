/**
*
*   ModelViewForm.js
*   Declarative MV Form building, rendering, localisation, validation
*   @dependencies: jQuery, ModelView, ModelViewValidation, Xpresion (optional, for custom field expressions)
*   @version: 1.1.0
*
*   https://github.com/foo123/modelview.js
*   https://github.com/foo123/modelview-form.js
*
**/
!function(l,C,i,s){"use strict";var e,d,t=Object.create,a="prototype",S=Object[a].hasOwnProperty,x="toUpperCase",c=Object.keys,r=Object[a].toString,j="getAttribute",D="setAttribute",L="hasAttribute",o=JSON.stringify,u=(JSON.parse,atob),f=(btoa,encodeURIComponent),v=(decodeURIComponent,function(e){return"[object Object]"===r.call(e)}),m=function(e){return"[object Array]"===r.call(e)},p=/^\s+|\s+$/g,h=String[a].trim?function(e){return e.trim()}:function(e){return e.replace(p,"")},O=/^\d+$/,g=/\[([^\]]*)\]/g,M=/\[\s*\]$/,E=/^\.+/g,F=/^\.+|\.+$/g,k=function(e){return e.replace(g,".$1").replace(E,"")},b=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,y=function(e){return e.replace(b,"\\$&")},T=function(e,t){return new RegExp(e,t||"")},R=i.Type.Cast,_=i.Validation.Validate,A=i.Event.Dispatch,P=i.UUID,I=i.Model;function V(e){return"mv-form-"+String(e)}function U(e,t){return!!e&&e.length}function N(e,n){var r=n.$view.$model,o=r.id+".",i=!1,l={},s=!1;return e.each(function(){var e,t,a=C(this),r=a.attr("name");r&&(t=r.replace(g,".$1").replace(F,""),o===t.slice(0,o.length)&&(t=t.slice(o.length),e=a.attr(V("ajax-options")),r=a.attr(V("key")),(t=(t=a.attr(V("ajax-key")))||r)&&r&&e&&(l[r]={key:t,model_key:r,options:e,$el:a,_inited:0},i=!0)))}),!i||(r.on("change",function(e,t){var a,i;t.key&&S.call(l,t.key)&&((a={})[(i=l[t.key]).key]=r.get(i.model_key),i.$el.addClass("mvform-progress"),n.trigger("before-ajax-options",i),d.doGET(i.options,a,function(e,t){if(A("change",function(e,t){t=t||[];var a,r,o,i,n,l,s="";for((a=e.attr(V("selected-multiple")))?(e.removeAttr(V("selected-multiple")),a=a.split(",")):(a=e.attr(V("selected")))?e.removeAttr(V("selected")):a=e.val(),r=0,o=t.length;r<o;r++)n=t[r],n=v(n)?(i=n.key,n.value):i=n,s+='<option value="'+i+'">'+n+"</option>";return(l=(l=e.children("optgroup")).length?l.eq(0):e).children("option:not(.default,.placeholder)").remove(),l.append(s),e.val(a),e}(i.$el,t||[]).removeClass("mvform-progress")[0]),n.trigger("after-ajax-options",i),!0===s){i._inited=1;var a,r=0,o=0;for(a in l)S.call(l,a)&&(o++,l[a]._inited&&r++);0<o&&o===r&&(s=!1,n.trigger("inited"))}}))}),s=!0,r.notify(c(l),"change"),!1)}function B(a,e){if("function"==typeof a)return a;if(e){var r=T("^"+y(e)+"([\\.\\[].+)$");return function(e){var t,e=e[j](a);return e&&(t=e.match(r))?t[1]:null}}return function(e){return e[j](a)}}function H(o,e){return"function"==typeof o?o:!1!==e?function(e){var t=e[L]("data-alt-value")?e[j]("data-alt-value"):null,a=("value"===o?t&&null!=e[t]?e[t]:C(e).val():e[j](o))||"",r=(e[j]("type")||e.tagName||"").toLowerCase();return"file"===r?t&&null!=e[t]&&e[t].length?e[t]:e.files&&e.files.length?e.files:null:("checkbox"!==r&&"radio"!==r||e.checked)&&("select"!==r||a.length&&-1!==e.selectedIndex)&&("text"!==r&&"textarea"!==r||h(a).length)?a:s}:function(e){var t=e[L]("data-alt-value")?e[j]("data-alt-value"):null,a=("value"===o?t&&null!=e[t]?e[t]:C(e).val():e[j](o))||"",r=(e[j]("type")||e.tagName).toLowerCase();return"file"===r?t&&null!=e[t]&&e[t].length?e[t]:e.files&&e.files.length?e.files:null:"checkbox"!==r&&"radio"!==r||e.checked?a:s}}function $(e,t,a,r,o,i){r=B(r||"name",t.id),o=H(o||"value",!1),i=!0===i;for(var l=0,s=e.length;l<s;l++){var d,c,u,f,v,m,p,h,g,E,b,y,T,A,I,N,$=e[l],w=(C($),r($));if(w){if(T=M.test(w),b="radio"===(h=($[j]("type")||"").toLowerCase())||"checkbox"===h,y="file"===h,A=(I=$[L]("data-else"))?$[j]("data-else"):null,null==(d=o($))){if(!(y||T||"checkbox"===h&&!$.checked&&I))continue;d=null}if(c=(u=k(w)).replace(F,""),m=d||"",p="",g=!!$[j]("required"),E=!!$[j](V("required")),$[L]("id")||$[j]("id",P(c.split(".").join("_"))),w=$[j](V("type"))||h)switch(w=w[x]()){case"NUMBER":case"INTEGER":case"INT":t.types[c]=R.INT,m=R.INT(m)||0,p=0,b&&!T&&I&&(p=R.INT(A)||0);break;case"BOOLEAN":case"BOOL":t.types[c]=R.BOOL,p=!(m=R.BOOL(m)||!1),b&&!T&&I&&(p=R.BOOL(A));break;case"EMAIL":case"URL":case"TEXT":case"STRING":case"STR":t.types[c]=R.STR,m=R.STR(m)||"",p="",b&&!T&&I&&(p=R.STR(A)||"");break;default:S.call(R,w)&&(t.types[c]=R[w],b&&!T&&I&&(p=R[w](A)))}for(T||((A=$[j](V("validate")))||g||E||"email"===h||"url"===h||"datetime"===h||"date"===h||"time"===h)&&(A?"BETWEEN"===(A=A[x]())?(N=[parseInt($[j](V("min")),10),parseInt($[j](V("max")),10)],isNaN(N[0])||isNaN(N[1])||(t.validators[c]=S.call(t.validators,c)?t.validators[c].AND(_.BETWEEN(N[0],N[1],!1)):_.BETWEEN(N[0],N[1],!1))):"GREATER_THAN"===A?(N=parseInt($[j](V("min")),10),isNaN(N)||(t.validators[c]=S.call(t.validators,c)?t.validators[c].AND(_.GREATER_THAN(N,!0)):_.GREATER_THAN(N,!0))):"LESS_THAN"===A?(N=parseInt($[j](V("max")),10),isNaN(N)||(t.validators[c]=S.call(t.validators,c)?t.validators[c].AND(_.LESS_THAN(N,!0)):_.LESS_THAN(N,!0))):"DATETIME"===A||"DATE"===A||"TIME"===A?(N=$[j](V("format"))||"Y-m-d H:i:s",t.validators[c]=S.call(t.validators,c)?t.validators[c].AND(_.DATETIME(N,a&&a.datetime?a.datetime:null)):_.DATETIME(N,a&&a.datetime?a.datetime:null)):"FILESIZE"===A?(N=parseInt($[j](V("filesize")),10)||1048576,t.validators[c]=S.call(t.validators,c)?t.validators[c].AND(_.FILESIZE(N)):_.FILESIZE(N)):"FILETYPE"===A||"FILEMIMETYPE"===A?(N=$[j](V("filetype")),t.validators[c]=S.call(t.validators,c)?t.validators[c].AND(_.FILETYPE(N)):_.FILETYPE(N)):S.call(_,A)&&(t.validators[c]=S.call(t.validators,c)?t.validators[c].AND(_[A]):_[A]):"email"===h?t.validators[c]=S.call(t.validators,c)?t.validators[c].AND(_.EMAIL):_.EMAIL:"url"===h?t.validators[c]=S.call(t.validators,c)?t.validators[c].AND(_.URL):_.URL:"datetime"!==h&&"date"!==h&&"time"!==h||(N=$[j](V("format"))||"Y-m-d H:i:s",t.validators[c]=S.call(t.validators,c)?t.validators[c].AND(_.DATETIME(N,a&&a.datetime?a.datetime:null)):_.DATETIME(N,a&&a.datetime?a.datetime:null)),$[L]("mv-model-evt")||$[D]("mv-model-evt",""),$[L]("mv-on-model-change")||$[D]("mv-on-model-change","change"),$[L]("mv-on-model-error")||$[D]("mv-on-model-error","error")),g||E?(y=T?y?_.MIN_FILES(parseInt($[j](V("leastrequired")),10)||1):_.MIN_ITEMS(parseInt($[j](V("leastrequired")),10)||1,U):y?_.MIN_FILES(1):_.NOT_EMPTY,t.validators[c]=S.call(t.validators,c)?y.AND(t.validators[c]):y,t.validators[c].REQUIRED=1,g&&$.removeAttribute("required"),$[L]("mv-model-evt")||$[D]("mv-model-evt",""),$[L]("mv-on-model-change")||$[D]("mv-on-model-change","change"),$[L]("mv-on-model-error")||$[D]("mv-on-model-error","error")):T||"function"!=typeof t.validators[c]||t.validators[c].REQUIRED||(t.validators[c]=_.EMPTY.OR(t.validators[c])),u=u.split("."),v=t.data;u.length;)if(f=u.shift(),u.length){if(S.call(v,f))!i&&O.test(u[0])&&v[f].length<=(n=parseInt(u[0],10))&&(v[f]=v[f].concat(new Array(n-v[f].length+1)));else if(T&&1===u.length){if(d instanceof FileList){v[f]=m;break}v[f]=[]}else!i&&O.test(u[0])?v[f]=new Array(parseInt(u[0],10)+1):v[f]={};v=v[f]}else T?null!=m&&v.push(m):v[f]=T||"checkbox"!==h||$.checked||!I?m:p}}}function w(e,t,a,r){var o,i,n;if(r)if(m(t))if(M.test(r))for(i=0,n=t.length;i<n;i++)a(e,r,t[i]);else for(i=0,n=t.length;i<n;i++)w(e,t[i],a,r+"["+("object"==typeof t[i]?i:"")+"]");else if(t instanceof FileList)for(i=0,n=t.length;i<n;i++)a(e,r,t[i]);else if(t instanceof File||t instanceof Blob)a(e,r,t);else if(t&&"object"==typeof t)for(o in t)S.call(t,o)&&w(e,t[o],a,r+"["+o+"]");else a(e,r,t);else if(m(t))for(i=0,n=t.length;i<n;i++)a(e,t[i].name,t[i].value);else if(t instanceof FileList)for(i=0,n=t.length;i<n;i++)a(e,r,t[i]);else if(t instanceof File||t instanceof Blob)a(e,r,t);else if(t&&"object"==typeof t)for(o in t)S.call(t,o)&&w(e,t[o],a,o);return e}function G(e,t,a){"function"==typeof a&&(a=a()),a instanceof FileList||a instanceof File||a instanceof Blob||e.push(f(t)+"="+f(null==a?"":a))}function Y(e,t,a){if("function"==typeof a&&(a=a()),a instanceof FileList)for(var r=0,o=a.length;r<o;r++)e.append(t,a[r],a[r].name);else a instanceof File?e.append(t,a,a.name):e.append(t,null==a?"":a)}((e=function(){i.View.apply(this,arguments)})[a]=t(i.View[a])).do_change=function(e,t){var a=C(t),r=V("proxy"),r=t[L](r)&&t[j](r);t.validity.valid||t.setCustomValidity(""),a.hasClass("mvform-error")&&a.removeClass("mvform-error"),r&&C(r).removeClass("mvform-error")},e[a].do_error=function(e,t){var a=C(t),r=V("proxy"),r=t[L](r)&&t[j](r);t.validity.valid||t.setCustomValidity(""),a.hasClass("mvform-error")||a.addClass("mvform-error"),r&&C(r).addClass("mvform-error")},(d=l.ModelViewForm=function e(t){if(!(this instanceof e))return new e(t);this.id=P("mvform"),this.$options=C.extend({submit:!0,upload:!1,ajax:!1,notify:!0,model:!1,livebind:!1,prefixed:!1,locale:{},Model:e.Model,View:e.View},t||{}),this.initPubSub()}).VERSION="1.1.0",d.Model=I,d.View=e,d.doSubmit=function(o,i,e){return i=i||"json",!0===e?(o="POST",function(e,t,a){var r=function(e,t){a("success"==t,e)};!t instanceof l.FormData&&(t=new l.FormData(t));r={type:o,method:o,dataType:i,url:e,data:t||null,processData:!1,contentType:!1,success:r,error:r};C.ajax(r)}):function(e,t,a){var r=function(e,t){a("success"==t,e)},r={type:o,method:o,dataType:i,url:e,data:t||null,success:r,error:r};void 0!==l.FormData&&t instanceof l.FormData&&(r.processData=!1,r.contentType=!1),C.ajax(r)}},d.doGET=d.doSubmit("GET","json"),d.doPOST=d.doSubmit("POST","json"),d.doUpload=d.doSubmit("POST","json",!0),d.Attr=V,d.getKey=B,d.getValue=H,d.toBlob=function(e,t){var a,r,o,i,n,l,s,d;for("data:"===e.substr(0,5)?(a=-1<(d=e.indexOf(";base64,"))?(o=e.slice(5,d),e=e.slice(d+8),u(e)):(o=e.slice(5,d=e.indexOf(",")),e=e.slice(d+1),unescape(e)),null==t&&(t=o)):a=e,l=a.length,r=new Uint8Array(l),n=15&l,i=0;i<n;i++)r[i]=255&a.charCodeAt(i);for(i=n;i<l;i+=16)r[s=i]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(s++),r[s]=255&a.charCodeAt(+s);return new Blob([r],{type:t})},d.toModel=$,d.toJSON=function(e){return o(e||{})},d.toFormData=function(e,t,a){return null==a&&"undefined"!=typeof FormData&&(a=FormData),a&&e instanceof a?e:w(t||new a,e||{},Y)},d.toUrlEncoded=function(e,t,a){return e=w(t||[],e||{},G),!0!==a&&(e=e.join("&").split("%20").join("+")),e},d[a]=i.Extend(t(Object[a]),i.PublishSubscribeInterface,{constructor:d,id:null,$form:null,$view:null,$options:null,dispose:function(){var e=this;return e.disposePubSub(),e.$form&&(e.$form.off("submit."+e.id),e.$form.modelview("dispose"),e.$form.removeClass("mvform")),e.$form=null,e.$view=null,e.$options=null,e.id=null,e},trigger:function(e,t,a){var r=this,o=i.PublishSubscribeInterface.trigger;return 0<(a=a||0)?setTimeout(function(){o.call(r,e,t)},a):o.call(r,e,t),r},one:function(e,t){return this.on(e,t,!0)},dom:function(e){return this.$form=C(e),this._render(),this},tpl:function(e,t){return this.$form=C(e.innerHTML).appendTo(t),this._render(),this},serialize:function(){var e={};return e[this.$view.$model.id]=this.$view.$model.serialize(),e},validate:function(){var e,t=this;t.$form,t.$options;return t.trigger("before-validate"),e=t.$view.$model.validate(),t.trigger("after-validate",e),e},notify:function(e){var t,a=this,r=a.$form,o=V("error");return r&&r.length&&e&&e.length&&(a.$view.$model.notify(e,"error"),(t=r.find("["+o+"]")).length&&(t.hide(),o=o+'="'+(a.$options.prefixed?a.$view.$model.id+".":""),r.find("["+o+e.join('"],['+o)+'"]').show())),a},_render:function(){var r=this,e=r.$options||{},t=e.Model||d.Model,a=e.View||d.View,o=r.$form,i={id:e.model?e.model:(i=o.attr(V("model")))?i:"model",data:{},types:{},validators:{},getters:{},setters:{},dependencies:{}};return o.addClass("mvform").prop("disabled",!1).attr("id",o[0].id||P("mvform")),r.trigger("before-render"),o.find("["+V("error")+"]").hide(),$(o.find("input,textarea,select"),i,e.locale),o.modelview({autoSync:!0,autobind:!0,livebind:!!e.livebind&&"text",autovalidate:!1,events:["change","error","click"],model:i,modelClass:t,viewClass:a}),r.$view=o.modelview("view"),e.submit&&o.on("submit."+r.id,function(e){var t,a=r.$options;if(!0!==a.disabled)return e.preventDefault(),e.stopPropagation(),o.find("["+V("error")+"]").hide(),(t=r.validate()).isValid?a.ajax?(r.trigger("before-send",e=r.serialize()),e&&a.ajax&&(a.upload?d.doUpload(a.ajax,d.toFormData(e),function(e,t){r.trigger("after-send",{success:e,response:t})}):d.doPOST(a.ajax,e,function(e,t){r.trigger("after-send",{success:e,response:t})}))):r.trigger("submit",r.serialize()):a.notify&&r.notify(t.errors),!1}),r.trigger("after-render"),N(o.find("select["+V("ajax-options")+"]"),r)&&r.trigger("inited"),r}})}(window,jQuery,ModelView);